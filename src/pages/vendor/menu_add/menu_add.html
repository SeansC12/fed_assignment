<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add New Item | MyHawker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="min-h-screen font-sans">
    <header
      class="bg-white border-b border-gray-200 py-4 px-6 sticky top-0 z-50 shadow-sm"
    >
      <div class="max-w-5xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
          <a
            href="../menu_arrange/menu_arrange.html"
            class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500"
          >
            <i data-lucide="arrow-left" class="w-6 h-6"></i>
          </a>
          <h1 class="text-xl font-bold text-gray-800">Add New Menu Item</h1>
        </div>
        <button
          onclick="handleSubmit()"
          class="bg-orange-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-orange-700 transition-all shadow-md active:scale-95"
        >
          Save Item
        </button>
      </div>
    </header>

    <main class="max-w-5xl mx-auto p-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
        <div class="space-y-4">
          <label
            class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wider"
            >Item Photo</label
          >

          <div
            class="relative group aspect-square bg-white rounded-[2rem] overflow-hidden border-2 border-dashed border-gray-300 flex items-center justify-center"
          >
            <img
              id="imagePreview"
              src="https://placehold.co/600x600?text=No+Image+Selected"
              class="w-full h-full object-cover"
            />

            <label
              for="fileInput"
              class="absolute top-4 right-4 bg-white p-3 rounded-xl shadow-lg text-gray-700 hover:text-orange-600 cursor-pointer transition-all transform hover:scale-110 active:scale-90 border border-gray-100"
            >
              <i data-lucide="pencil-line" class="w-5 h-5"></i>
              <input
                type="file"
                id="fileInput"
                class="hidden"
                accept="image/*"
                onchange="previewImage(event)"
              />
            </label>
          </div>
        </div>

        <div class="flex flex-col gap-6">
          <div
            class="bg-white p-8 rounded-[2rem] shadow-sm border border-gray-200 space-y-6"
          >
            <div>
              <label
                class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wider"
                >Item Name</label
              >
              <input
                type="text"
                id="itemName"
                placeholder="e.g. Signature Laksa"
                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 focus:ring-4 focus:ring-red-50 focus:outline-none transition-all"
              />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wider"
                  >Price ($)</label
                >
                <input
                  type="number"
                  id="itemPrice"
                  step="0.10"
                  placeholder="0.00"
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 focus:ring-4 focus:ring-red-50 focus:outline-none transition-all"
                />
              </div>
              <div>
                <label
                  class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wider"
                  >Category</label
                >
                <select
                  id="itemCategory"
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 focus:ring-4 focus:ring-red-50 focus:outline-none transition-all bg-white"
                >
                  <option>Mains</option>
                  <option>Drinks</option>
                  <option>Sides</option>
                </select>
              </div>
            </div>

            <div>
              <label
                class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wider"
                >Description</label
              >
              <textarea
                id="itemDesc"
                rows="4"
                placeholder="Describe the ingredients..."
                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 focus:ring-4 focus:ring-red-50 focus:outline-none transition-all resize-none"
              ></textarea>
            </div>
          </div>

          <div class="flex gap-4">
            <button
              onclick="handleSubmit()"
              class="flex-1 bg-orange-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-orange-700 transition-all shadow-lg active:scale-[0.98] flex items-center justify-center gap-2"
            >
              <i data-lucide="plus-circle" class="w-6 h-6"></i>
              Confirm & Add Item
            </button>
            <a
              href="../menu_arrange/menu_arrange.html"
              class="px-8 py-4 bg-gray-200 text-gray-600 rounded-2xl font-bold hover:bg-gray-300 transition-all flex items-center shadow-sm"
            >
              Cancel
            </a>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDxw4nszjHYSWann1cuppWg0EGtaa-sjxs",
        authDomain: "fed-assignment-f1456.firebaseapp.com",
        projectId: "fed-assignment-f1456",
        storageBucket: "fed-assignment-f1456.firebasestorage.app",
        messagingSenderId: "646434763443",
        appId: "1:646434763443:web:40ca6ecd4edd45e2edf6c6",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const menuCol = collection(db, "vendor_menu");

      // --- STALL ID LOGIC ---
      let stallId = localStorage.getItem("activeStallId");

      // PLACEHOLDER: Use this until your login page is ready
      if (!stallId) {
        stallId = "NkfmlElwOWPU0Mb5L40n"; 
        console.warn("Using placeholder Stall ID for new menu item:", stallId);
      }

      let encodedImage = "https://placehold.co/600x600?text=No+Image+Selected";

      // Preview logic
      window.previewImage = (event) => {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function () {
          encodedImage = reader.result;
          document.getElementById("imagePreview").src = encodedImage;
        };
        reader.readAsDataURL(file);
      };

      // Submit logic
      window.handleSubmit = async () => {
        const name = document.getElementById("itemName").value;
        const priceInput = document.getElementById("itemPrice").value;

        if (!name || !priceInput) {
          alert("Please enter at least a name and price!");
          return;
        }

        const isConfirmed = confirm(`Add "${name}" to your cloud menu?`);

        if (isConfirmed) {
          try {
            const priceNumber = parseFloat(priceInput);

            await addDoc(menuCol, {
              stallId: stallId, // <--- NEW FIELD ADDED HERE
              name: name,
              price: priceNumber,
              category: document.getElementById("itemCategory").value,
              desc: document.getElementById("itemDesc").value,
              image: encodedImage,
              stock: true,
              createdAt: new Date(),
            });

            window.location.href = "../menu_arrange/menu_arrange.html";
          } catch (error) {
            console.error("Error adding document: ", error);
            alert("Failed to save to database.");
          }
        }
      };

      lucide.createIcons();
    </script>
  </body>
</html>
